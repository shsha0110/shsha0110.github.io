---
title: "A Gentle Introduction to Conformal Prediction and Distribution-Free Uncertainty Quantification (Part 4.1)"
subtitle: "4.1. Group-Balanced Conformal Prediction"
author: "유성현"
date: "2026-01-16"
categories: [Paper Review]
format:
  html:
    toc: true
    number-sections: false
    code-fold: show
---

# Introduction: The Fairness Problem

* 지금까지 우리는 전체 데이터셋에 대해 평균적으로 $1-\alpha$의 커버리지를 보장하는 방법(Marginal Coverage)을 배웠습니다.
* 하지만 현실 세계, 특히 의료나 금융 같은 민감한 분야에서는 "평균적인 성공"만으로는 충분하지 않습니다.

* 예를 들어, 어떤 질병 진단 AI가 백인 환자에게는 99%의 정확도를 보이지만, 유색 인종 환자에게는 80%의 정확도밖에 보이지 않는다고 가정해봅시다.
* 이 경우 백인 환자가 다수라면 전체 평균 정확도는 90%를 넘길 수 있겠지만, 이는 **공정하지 못한(Unfair)** 시스템입니다.

* **Group-Balanced Conformal Prediction**은 이러한 문제를 해결하기 위해, 데이터 내의 특정 그룹(인종, 성별, 연령대 등) 각각에 대해 독립적으로 커버리지를 보장하는 기법입니다.

# Problem Formulation

* 우리의 입력 데이터 $X$의 첫 번째 특성(Feature) $X_{i,1}$이 그룹을 나타내는 범주형 변수라고 가정해봅시다.
* 이 그룹은 $\{1, \dots, G\}$ 중 하나의 값을 가집니다.

* 기존의 CP는 다음을 보장했습니다:
$$ \mathbb{P}(Y_{test} \in \mathcal{C}(X_{test})) \ge 1-\alpha $$

* 하지만 우리가 원하는 것은 **모든 그룹 $g$에 대해** 다음이 성립하는 것입니다:

$$
\mathbb{P}(Y_{test} \in \mathcal{C}(X_{test}) \mid X_{test,1} = g) \ge 1-\alpha, \quad \forall g \in \{1, \dots, G\}
$$

* 즉, 어떤 그룹에 속한 데이터가 들어오더라도 똑같이 $1-\alpha$ 이상의 확률로 정답을 포함해야 합니다.

# The Algorithm

* 이 문제를 해결하는 방법은 직관적입니다. **"그룹별로 따로따로 Conformal Prediction을 수행"**하는 것입니다.

## Step 1: Stratify Calibration Data
* Calibration 데이터셋을 그룹별로 나눕니다.
* 그룹 $g$에 속하는 데이터들만 모아서 부분집합을 만듭니다.

$$
S^{(g)} = \{ (X_j, Y_j) : X_{j,1} = g \}
$$

## Step 2: Calibrate per Group
* 각 그룹 $g$에 대해 독립적으로 Quantile $\hat{q}^{(g)}$를 계산합니다.
* 1.  그룹 $g$ 데이터에 대한 Conformal Score들을 계산합니다: 
$$s^{(g)}_1, \dots, s^{(g)}_{n^{(g)}}$$
* 2.  해당 그룹의 데이터 개수 $n^{(g)}$를 기준으로 보정된 분위수를 구합니다:
$$
\hat{q}^{(g)} = \text{Quantile}\left( \frac{\lceil (n^{(g)}+1)(1-\alpha) \rceil}{n^{(g)}} ; \{s^{(g)}_1, \dots, s^{(g)}_{n^{(g)}}\} \right)
$$

* 결과적으로 우리는 그룹의 개수만큼 서로 다른 임계값(Threshold) $\hat{q}^{(1)}, \dots, \hat{q}^{(G)}$를 얻게 됩니다.
  * 모델이 잘 맞추는 쉬운 그룹은 $\hat{q}$가 작을 것이고 (작은 예측 집합),
  * 모델이 어려워하는 그룹은 $\hat{q}$가 클 것입니다 (큰 예측 집합).

## Step 3: Inference
* 새로운 테스트 데이터 $X_{test}$가 들어오면, 먼저 이 데이터가 어느 그룹에 속하는지($X_{test,1}$) 확인합니다.
* 그리고 해당 그룹에 맞는 임계값 $\hat{q}^{(X_{test,1})}$을 사용하여 예측 집합을 구성합니다.

$$
\mathcal{C}(x) = \{ y : s(x, y) \le \hat{q}^{(x_1)} \}
$$

![Figure: Group-Balanced Conformal Prediction의 개념도. 전체 데이터를 파란색 그룹과 초록색 그룹으로 나누고, 각각의 분포(Histogram)에서 별도의 Quantile $\hat{q}^{(1)}, \hat{q}^{(2)}$를 계산하여 적용한다.](images/group_balanced_cp_visualization.png)

# Theoretical Guarantee

* 이 방법은 Vovk에 의해 처음 제안되었으며, 다음의 명제에 의해 수학적으로 정당화됩니다.

> **Proposition 1 (Error control guarantee for group-balanced conformal prediction)**
>
> 데이터가 i.i.d. 가정하에 추출되었다면, 위 알고리즘을 통해 생성된 예측 집합 $\mathcal{C}$는 모든 그룹 $g$에 대해 다음을 만족한다.
>
> $$ \mathbb{P}(Y_{test} \in \mathcal{C}(X_{test}) \mid X_{test,1} = g) \ge 1-\alpha $$

* 이로써 우리는 인종, 성별 등 민감한 속성에 관계없이 모든 사용자에게 **동등한 수준의 안전장치(Equal Coverage)**를 제공할 수 있게 됩니다.

# Practical Note

* **Explicit Groups**: 인종, 성별처럼 데이터에 명시적으로 존재하는 카테고리를 사용할 수 있습니다.
* **Constructed Groups (Binning)**: 나이(Age)와 같은 연속형 변수라도, '20대', '30대' 등으로 구간화(Binning)하여 그룹을 만든 뒤 이 방법을 적용할 수 있습니다. 이를 통해 연속적인 특성에 대한 Conditional Coverage를 근사할 수 있습니다.

---
**Next Step**: 그룹 정보가 입력(Input Feature)으로 주어지는 경우에는 위 방법을 쓰면 됩니다. 하지만, **"실제 정답 클래스(Class)"별로 커버리지를 보장하고 싶다면** 어떻게 해야 할까요? (예: 암 환자를 암이라고 맞출 확률과 정상인을 정상이라고 맞출 확률을 동시에 보장). 다음 포스트에서는 **Section 4.2 Class-Conditional Conformal Prediction**을 다루겠습니다.