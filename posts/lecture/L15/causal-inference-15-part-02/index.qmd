---
title: "[Causal Inference] 15. DiD & SCM (Part 2)"
description: "Nonlinear DiD"
author: "유성현"
date: "2026-01-22"
categories: [Causal Inference]
format:
  html:
    toc: true
    number-sections: false
    code-fold: show
    math: true
---

# Overview: 선형 DiD의 한계

* 표준 이중차분법(Standard DiD)은 강력하지만, 중요한 가정을 전제로 합니다. 
* 바로 **"평행 추세(Parallel Trends)"** 가정입니다. 
* 하지만 이 가정은 결과 변수($Y$)의 **선형성(Linearity)**에 의존적이라는 한계가 있습니다.
* 예를 들어, 소득($Y$)에 대해서는 평행 추세가 성립하더라도, 로그 소득($\log Y$)에 대해서는 성립하지 않을 수 있습니다(Not invariant to nonlinear transformations). 
* 만약 정책 효과가 소득 구간별로 다르게 나타난다면(예: 저소득층에게 더 큰 효과), 평균값의 변화만 보는 선형 DiD는 이러한 분포의 변화를 놓치게 됩니다.
* 이번 포스트에서는 이러한 선형성 가정을 완화하고, 분포 전체의 변화를 추정할 수 있는 **비선형 이중차분법(Nonlinear DiD)**, 일명 **Changes-in-Changes (CiC)** 모델에 대해 알아봅니다.

---

# 1. 직관적 이해: 분위수 매핑 (Quantile Mapping)

* 비선형 DiD의 핵심 아이디어는 "평균의 변화"가 아니라 **"분위수(Quantile)의 변화"**를 비교하는 것입니다.

## 시각적 설명
* 아래 그림은 통제 집단(Control)과 처치 집단(Treated)의 누적 분포 함수(CDF)가 시간이 지남에 따라 어떻게 변하는지를 보여줍니다.

![Figure: $x$축은 결과값, $y$축은 확률(0~1)을 나타냅니다. $r_0(q)$와 $r_1(q)$는 각각 통제 집단과 처치 집단에서 특정 분위수 $q$에 해당하는 값의 시간적 변화(매핑)를 의미합니다.](./images/nonlinear_did_graph.png)

* **통제 집단의 변화 ($r_0(q)$):** $t=0$ 시점의 $q$ 분위수 값이 $t=1$ 시점에 어떻게 변했는지 보여줍니다.
* **가정:** 처치 집단이 처치를 받지 않았더라면, **"시간에 따른 분위수의 변화 양상"**이 통제 집단과 동일했을 것이라고 가정합니다.
* 즉, 통제 집단에서의 매핑(화살표)을 처치 집단에 그대로 적용하여 반사실(Counterfactual)을 구성합니다.

---

# 2. 수식적 정의 (Formalization)

* 이제 이를 수학적으로 엄밀하게 정의해 봅시다.

## 2.1 분포 함수 (Distribution Functions)
* 우선, 각 집단($G_i=g$)과 시점($t$)에서의 잠재적 결과(Potential Outcome) $Y(0)$(처치받지 않음)의 누적 분포 함수를 정의합니다.
$$
F_{gt}(y) = P(Y_{it}(0) \le y | G_i = g)
$$
    * $g \in \{0, 1\}\textit{(0: 통제, 1: 처치)}$
    * $t \in \{0, 1\}\textit{(0: 전, 1: 후)}$
* 우리가 관찰할 수 있는 분포들은 $F_{00}, F_{01}, F_{10}$입니다.
* 처치 집단의 사후 결과인 $F_{11}$은 처치($Y(1)$)를 받은 상태이므로, 처치를 받지 않았을 상태($Y(0)$)인 $F_{11}$은 **반사실(Counterfactual)**로서 식별해야 할 대상입니다.

## 2.2 분위수 처치 효과 (Quantile Treatment Effect, QTE)
* 우리의 목표는 특정 분위수 $q$에서의 처치 효과 $\tau(q)$를 구하는 것입니다.
$$
\tau(q) = \underbrace{\tilde{F}_{11}^{-1}(q)}_{\text{관측값}} - \underbrace{F_{11}^{-1}(q)}_{\text{반사실(추정값)}}
$$
    * $\tilde{F}_{11}(y) = P(Y_{i1}(1) \le y | G_i = 1)$: 
        * 실제로 관측된 처치 집단의 사후 결과 분포 ($Y(1)$).
    * $F_{11}(y)$: 
        * 우리가 추정해야 할 처치 집단의 반사실적 사후 결과 분포 ($Y(0)$).

---

# 3. 식별 가정 및 유도 (Identification)

* 비선형 DiD의 핵심 가정은 **"분위수 변화의 불변성"**입니다. 
* Athey & Imbens (2006)의 Changes-in-Changes 모델로도 알려져 있습니다.

## 3.1 식별 가정 (Identification Assumption)
* 모든 분위수 $q \in [0, 1]$에 대하여 다음이 성립한다고 가정합니다.

$$
F_{01}(F_{00}^{-1}(q)) = F_{11}(F_{10}^{-1}(q))
$$

* 이 수식의 의미를 단계별로 풀어보겠습니다.
    * 1.  **좌변 ($F_{01}(F_{00}^{-1}(q))$):** 
        * 통제 집단에서 시점 0에 $q$ 분위수에 해당하는 값($F_{00}^{-1}(q)$)을 찾습니다.
        * 그 값이 시점 1의 분포($F_{01}$)에서 차지하는 위치(확률)를 봅니다.
        * 즉, **통제 집단에서 시간이 흐름에 따라 순위(Rank)가 어떻게 변했는지**를 나타냅니다.
    * 2.  **우변 ($F_{11}(F_{10}^{-1}(q))$):** 
        * 처치 집단에서도 동일하게, 시점 0에 $q$ 분위수에 해당하는 값($F_{10}^{-1}(q)$)을 찾습니다.
        * 그 값이 시점 1의 반사실 분포($F_{11}$)에서 갖게 될 위치를 나타냅니다.
    * 3.  **결론:** "시간에 따른 상대적 위치(Rank)의 변화 함수"는 두 집단 간에 동일하다는 것입니다.

## 3.2 반사실 분포 $F_{11}(y)$의 유도 과정

* 우리는 $F_{11}(y)$를 구하고 싶습니다. 위 식별 가정을 이용하여 이를 $y$에 대한 함수로 정리해 봅시다.

* **단계 1: 목표 변수 설정**
    * 우변의 $F_{11}(\cdot)$ 안에 있는 $F_{10}^{-1}(q)$를 $y$라고 둡니다.
    * 즉, 어떤 결과값 $y$가 처치 집단의 사전 시점($t=0$)에서 갖는 누적 확률(분위수)을 $q'$라고 합시다.

$$
y = F_{10}^{-1}(q') \iff q' = F_{10}(y)
$$

* **단계 2: 가정식에 대입**
    * 식별 가정 식의 $q$ 자리에 $q' = F_{10}(y)$를 대입합니다.
$$
F_{01}(F_{00}^{-1}(q')) = F_{11}(F_{10}^{-1}(q'))
$$
    * 여기에 $q'$와 $y$의 관계를 적용하면:
$$
F_{01}(F_{00}^{-1}(F_{10}(y))) = F_{11}(y)
$$

* **단계 3: 결과 도출**
* 따라서, 처치 집단이 처치를 받지 않았을 때($t=1$)의 잠재적 분포 $F_{11}(y)$는 관찰 가능한 데이터($F_{01}, F_{00}, F_{10}$)만으로 다음과 같이 식별됩니다.

$$
F_{11}(y) = F_{01}\left[ F_{00}^{-1} \{ F_{10}(y) \} \right]
$$

## 3.3 해석
* 이 최종 수식은 다음과 같은 알고리즘으로 이해할 수 있습니다.
    * 1.  **$F_{10}(y)$:** 처치 집단의 $t=0$ 시점에서 결과값 $y$의 분위수(Rank)를 찾습니다.
    * 2.  **$F_{00}^{-1}(\cdot)$:** 통제 집단의 $t=0$ 시점에서 **동일한 분위수**를 가진 결과값을 찾습니다. (집단 간 비교 기준점 확보)
    * 3.  **$F_{01}(\cdot)$:** 그 결과값이 통제 집단의 $t=1$ 시점에서 갖는 새로운 분위수를 확인합니다. (시간 효과 반영)
    * 4.  **$F_{11}(y)$:** 이 "변환된 분위수"가 바로 처치 집단($t=1$)에서 $y$가 가질 누적 확률입니다.

---

## 4. 요약 및 시사점

* 비선형 DiD(CiC)는 평균값 비교에 그치는 기존 DiD의 한계를 넘어, 정책이 **전체 소득 분포나 특정 분위수(예: 하위 10%)**에 미치는 영향을 정밀하게 분석할 수 있게 해줍니다.

* **장점:**
    * 로그 변환 등 결과 변수의 비선형 변환에 영향을 받지 않습니다(Invariant).
    * 평균뿐만 아니라 분포 전체의 처치 효과(QTE)를 추정할 수 있습니다.
* **조건:**
    * 연속적인 결과 변수에 적합하며, 역함수($F^{-1}$)가 존재해야 하므로 분포 함수가 강단조증가(strictly increasing)해야 한다는 조건이 필요할 수 있습니다.