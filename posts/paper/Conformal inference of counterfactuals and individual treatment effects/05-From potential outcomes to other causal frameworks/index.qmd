---
title: "세계관의 확장: 다른 인과추론 프레임워크로의 연결"
subtitle: "Paper Review: Conformal inference of counterfactuals and individual treatment effects (Section 5)"
author: "Reviewer"
date: "2026-01-22"
categories: [Causal Inference, Pearl's Causal Diagram, Invariant Prediction]
format:
  html:
    toc: true
    number-sections: true
    math: true
---

## 들어가며

지금까지 우리는 **잠재적 결과(Potential Outcome) 프레임워크** (Rubin's Causal Model) 하에서 개별 처치 효과(ITE)의 구간을 추정하는 방법을 논의했습니다. 핵심은 **가중 컨포멀 추론(Weighted Conformal Inference)**을 이용해, 관측 데이터(학습 분포)와 우리가 추론하고자 하는 반사실/타겟 데이터(타겟 분포) 사이의 **공변량 변화(Covariate Shift)**를 보정하는 것이었습니다.

이 논문의 마지막 섹션(Section 5)에서는 매우 흥미로운 통찰을 제시합니다. 우리가 개발한 이 방법론이 단순히 잠재적 결과 프레임워크에만 국한되지 않는다는 것입니다.

**핵심 통찰 (Key Observation):**
> "조건부 분포의 불변성(Invariance of Conditional Distribution)과 공변량 변화(Covariate Shift)라는 구조만 동일하다면, 어떤 인과추론 프레임워크에도 이 방법론을 적용할 수 있다."

이번 포스트에서는 이 통찰이 **Judea Pearl의 인과 다이어그램**과 **Peters의 불변 예측** 프레임워크로 어떻게 확장되는지 수학적으로 살펴보겠습니다.

---

## 인과 다이어그램 프레임워크 (Causal Diagram Framework)

### Pearl의 do-연산자

Judea Pearl(1995)이 정립한 인과 다이어그램 프레임워크는 '반사실(Counterfactuals)' 개념 대신, **do-연산자($do(\cdot)$)**를 통해 인과 효과를 정의합니다. $do(T=t)$는 시스템에 개입하여 변수 $T$를 강제로 값 $t$로 고정하고, $T$로 들어오는 모든 인과적 경로를 끊는 것을 의미합니다.

### 가정: 백도어 기준 (Back-door Criterion)

우리는 변수 집합 $X$가 **백도어 기준**을 만족한다고 가정합니다.
* $X$는 모든 교란 변수(Confounders)를 포함합니다.
* $X$는 처치 이후의 변수(Post-treatment variables)를 포함하지 않습니다.

![Image: causal_diagram_backdoor.png]
*Figure 1: 백도어 기준을 만족하는 인과 다이어그램 예시. X는 T와 Y의 공통 원인(Confounder)을 차단하고 있다.*

### 수학적 구조의 일치성 증명

우리가 추론하고자 하는 **타겟 분포(Target Distribution)**는 개입이 일어났을 때의 분포입니다. Pearl(1995)의 기초 정리에 따르면, 백도어 기준이 만족될 때 다음이 성립합니다.

$$
P_{(X,Y)|do(T=t)} = P_X \times P_{Y|X, T=t}
$$

반면, 우리가 실제로 가지고 있는 **관측 분포(Observed Distribution)**는 다음과 같습니다.

$$
P_{(X,Y)|T=t} = P_{X|T=t} \times P_{Y|X, T=t}
$$

**[비교 분석]**
두 식을 비교해 봅시다.
1.  **조건부 분포 $P_{Y|X, T=t}$:** 두 식에서 **동일**합니다. 즉, $X$와 $T$가 정해졌을 때 $Y$가 결정되는 메커니즘은 변하지 않습니다 (Invariance).
2.  **공변량 분포:** 타겟은 $P_X$ (전체 모집단)이고, 관측은 $P_{X|T=t}$ (특정 처치군)입니다.

이 구조는 우리가 앞서 다루었던 잠재적 결과 프레임워크에서의 구조와 **수학적으로 완전히 동일**합니다.

### 결론: 가중치의 적용

따라서, 별도의 수정 없이 **Weighted Split-CQR** 알고리즘을 그대로 적용할 수 있습니다. 이때 가중치(Likelihood Ratio)는 다음과 같이 계산됩니다.

$$
w(x) = \frac{d P_X(x)}{d P_{X|T=t}(x)} \propto \frac{1}{P(T=t|X=x)}
$$

이는 성향 점수(Propensity Score)의 역수와 같습니다. 즉, **Pearl의 프레임워크에서도 성향 점수를 이용한 가중 컨포멀 추론이 유효함**을 증명한 것입니다.

---

## 불변 예측 프레임워크 (Invariant Prediction Framework)

### 문제 설정

Peters et al.(2016)이 제안한 불변 예측 프레임워크는 서로 다른 환경(Environments, 예: 유전자 노크아웃 실험 등)에서 데이터가 수집될 때 강력한 힘을 발휘합니다.

* $Y$: 결과 변수
* $X$: 개입 또는 공변량
* $E$: 환경 변수 (데이터 소스, $e_1, \dots, e_J$)

**핵심 가정 (Invariance Assumption):**
환경 $E$가 변하더라도, $X$가 주어졌을 때 $Y$의 조건부 분포는 변하지 않습니다.

$$
Y \perp E \mid X \quad \iff \quad P(Y|X, E) = P(Y|X)
$$

하지만 $X$의 분포는 환경에 따라 달라질 수 있습니다 ($X|E \sim P_X^E$). 우리의 목표는 새로운 타겟 환경 $e_0$에서의 결과를 예측하는 것입니다.

![Image: invariant_prediction_dag.png]
*Figure 2: 불변 예측의 구조. 환경 E는 X에 영향을 주지만, Y는 오직 X에 의해서만 직접적인 영향을 받는다(Y에 대한 E의 직접 경로 없음).*

### Case 1: 단일 소스 환경 ($J=1$)

데이터 소스가 하나($e_1$)이고, 타겟 환경이 $e_0$인 경우를 봅시다.

* **관측 분포 (Source):** $P_X^{e_1} \times P_{Y|X}$
* **타겟 분포 (Target):** $P_X^{e_0} \times P_{Y|X}$

이 역시 잠재적 결과 프레임워크와 동일한 **공변량 변화(Covariate Shift)** 문제입니다. 따라서 다음 가중치를 사용하여 Weighted Split-CQR을 적용하면 됩니다.

$$
w(x) = \frac{d P_X^{e_0}(x)}{d P_X^{e_1}(x)}
$$

### Case 2: 다중 소스 환경 ($J > 1$)

여러 환경 $e_1, \dots, e_J$에서 데이터 $(X_{ij}, Y_{ij})$가 수집된 경우는 조금 더 복잡합니다.

Tibshirani et al.(2019b)의 일반화된 가중치를 사용할 수도 있지만, 식이 매우 복잡해집니다. 논문은 대신 **가중 모집단(Weighted Population)**을 생성하는 대안을 제시합니다.

여러 환경의 데이터를 적절한 비율 $q_j$로 섞어서, 타겟 환경 $e_0$의 분포와 유사하게 만드는 아이디어입니다.

**[수학적 유도]**
관측된 혼합 분포를 다음과 같이 정의합니다.

$$
P_{Obs} = \left( \sum_{j=1}^J q_j P_X^{e_j} \right) \times P_{Y|X}
$$

우리가 원하는 타겟 분포는 $P_X^{e_0} \times P_{Y|X}$입니다. 따라서 이 혼합 데이터셋에 대해 다음 가중치를 적용하면 됩니다.

$$
w(x) = \frac{1}{\sum_{j=1}^J q_j \frac{d P_X^{e_j}}{d P_X^{e_0}}(x)}
$$

여기서 $q_j$는 공변량 분포의 균형을 맞추는 절차(Balancing procedures)를 통해 선택할 수 있습니다. 이를 통해 다중 환경 데이터를 통합하여 타겟 환경에 대한 이중 강건성(Doubly Robust)을 가진 구간 추정이 가능해집니다.

---

## 전체 요약 및 결론

이 논문은 **"평균(ATE)에서 개인(ITE)으로"**, 그리고 **"점 추정에서 구간 추정으로"** 인과추론의 패러다임을 확장했습니다.

1.  **문제의 재정의:** ITE 추정 문제를 **반사실(Counterfactual)의 예측 구간 생성** 문제로 치환했습니다.
2.  **방법론:** **가중 컨포멀 추론(Weighted Split-CQR)**을 도입하여, 학습 분포와 타겟 분포가 다른 상황(Covariate Shift)에서도 신뢰할 수 있는 구간을 생성했습니다.
3.  **이론적 보장:**
    * 무작위 실험(RCT)에서는 유한 샘플에서도 **완전한(Exact) 커버리지**를 보장합니다.
    * 관찰 연구(Observational Study)에서는 성향 점수나 결과 모델 중 하나만 정확해도 되는 **이중 강건성(Double Robustness)**을 가집니다.
4.  **확장성:** 이 방법론은 Pearl의 인과 다이어그램이나 불변 예측 프레임워크 등, **조건부 불변성**이 성립하는 모든 인과추론 문제에 범용적으로 적용될 수 있습니다.

결국, 이 연구는 불확실성이 가득한 세상에서 인과관계를 기반으로 한 의사결정을 내릴 때, **"얼마나 확신할 수 있는가?"**라는 질문에 답할 수 있는 강력하고 유연한 도구를 제공했다고 평가할 수 있습니다.

***
**Reference:**
Lei, L., & Candès, E. J. (2021). Conformal inference of counterfactuals and individual treatment effects. *Journal of the Royal Statistical Society: Series B (Statistical Methodology)*, 83(5), 911-938.