---
title: "[Paper Review] Conformal Inference of Counterfactuals and Individual Treatment Effects (Part 3)"
description: "Empirical Validation: Benchmarking Weighted Split-CQR against Causal Forest, X-learner, and BART."
author: "유성현"
date: "2026-01-23"
categories: [Paper Review]
format:
  html:
    toc: true
    number-sections: false
    code-fold: show
    math: true
---

# 1. Introduction

지난 포스트(Part 2)에서는 **Weighted Split-CQR** 알고리즘의 이론적 배경과 이중 강건성(Double Robustness)에 대해 살펴보았습니다. 이론적으로는 이 방법론이 성향 점수(Propensity Score)나 결과 모델(Outcome Model) 중 하나만 정확해도 유효한 커버리지를 제공함을 증명했습니다.

이번 포스트(Part 3)에서는 **수치 실험(Numerical Experiments)**을 통해 이 이론이 실제 데이터(Simulation)에서 어떻게 작동하는지 확인합니다. 특히, CATE(조건부 평균 처치 효과) 추정에 널리 쓰이는 최신 방법론들(Causal Forest, X-learner, BART)과 비교하여, **ITE(개별 처치 효과) 예측 구간**의 성능을 집중적으로 분석합니다.

---

# 2. Simulation Setup

[cite_start]저자들은 Wager and Athey (2018)의 설정을 변형하여 시뮬레이션을 설계했습니다[cite: 380].

## 2.1 Data Generation Process

* **Covariates ($X$):**
    $X = (X_1, ..., X_d)^T$는 다변량 가우시안 분포에서 생성된 뒤 변환됩니다.
    $$X_j = \Phi(X_j')$$
    여기서 $\Phi$는 표준정규분포의 CDF이며, $Var(X_j')=1$, $Cov(X_j', X_{j'}') = \rho$입니다. [cite_start]$\rho=0$이면 독립, $\rho>0$이면 상관관계가 존재합니다[cite: 381].

* **Potential Outcomes:**
    [cite_start]순수한 반사실적(Counterfactual) 추론 문제를 다루기 위해 $Y(0) \equiv 0$으로 고정합니다[cite: 383].
    $Y(1)$은 다음과 같이 생성됩니다:
    
    $$
    \mathbb{E}[Y(1)|X] = f(X_1)f(X_2), \quad f(x) = \frac{2}{1+\exp\{-12(x-0.5)\}}
    $$
    
    $$
    Y(1) = \mathbb{E}[Y(1)|X] + \sigma(X)\epsilon, \quad \epsilon \sim N(0, 1)
    $$
    
    [cite_start]이 설정은 비선형성(Non-linearity)을 포함하고 있습니다 [cite: 385-387].

* **Propensity Score:**
    [cite_start]성향 점수 $e(x)$는 다음과 같이 설정하여, 항상 $0.25 \le e(x) \le 0.5$ 범위에 있도록 하여 충분한 Overlap을 보장합니다 [cite: 389-394].
    
    $$
    e(x) = \frac{1}{4}(1 + \beta_{2,4}(X_1))
    $$
    여기서 $\beta_{2,4}$는 Beta(2,4) 분포의 CDF입니다.

## 2.2 Scenarios

[cite_start]총 $2 \times 2 \times 2 = 8$가지 시나리오를 고려합니다[cite: 395].

1.  **Dimension:** Low ($d=10$) vs. High ($d=100$)
2.  **Correlation:** Uncorrelated ($\rho=0$) vs. Correlated ($\rho=0.9$)
3.  **Error Variance:** Homoscedastic ($\sigma^2(x) \equiv 1$) vs. Heteroscedastic ($\sigma^2(x) = -\log X_1$)

---

# 3. Competing Methods

본 연구의 방법론(Weighted Split-CQR)을 다음의 세 가지 널리 알려진 방법들과 비교합니다.

1.  **Causal Forest (CF):** `grf` 패키지 사용. Infinitesimal Jackknife를 사용해 CATE의 분산을 추정합니다. [cite_start]본래 ITE 구간 추정용은 아닙니다 [cite: 397-399].
2.  **X-learner:** `causalToolbox` 패키지 사용. Bootstrap을 사용해 CATE의 분산을 추정합니다. [cite_start]역시 ITE용은 아닙니다 [cite: 400-402].
3.  **BART (Bayesian Additive Regression Trees):** `bartMachine` 패키지 사용. [cite_start]베이지안 기법으로 Credible Interval(CATE용)과 Prediction Interval(ITE용)을 모두 생성할 수 있어 가장 강력한 경쟁자입니다 [cite: 403-406].

[cite_start]**Weighted Split-CQR (Our Method)**은 성향 점수 추정에 Gradient Boosting을 사용하며, 조건부 분위수(Quantile) 추정에는 (1) Quantile RF, (2) Quantile Boosting, (3) BART 세 가지를 각각 적용하여 테스트했습니다 [cite: 407-408].

---

# 4. Results: Coverage Performance

실험은 100번 반복되었으며, 매번 10,000개의 테스트 포인트에 대해 95% 신뢰구간/예측구간을 생성했습니다.

## 4.1 Theoretical vs. Empirical Coverage

먼저 각 방법론이 이론적으로 보장하는 커버리지와 실제 시뮬레이션 결과를 요약한 표입니다.

![Figure 1: Table 2 - Summary of coverage guarantees. 이론적으로 Causal Forest와 X-learner는 CATE만 커버하도록 설계되었으며, ITE는 커버하지 못합니다. BART와 CQR만이 ITE 커버리지를 목표로 합니다.](./images/table2_summary.png)

* **이론(Theory):** CF와 X-learner는 CATE($\tau(x)$)에 대한 커버리지만 보장합니다. [cite_start]반면, CQR은 ITE($Y(1)-Y(0)$)에 대한 커버리지를 보장합니다 [cite: 428-430].
* **실제(Simulation):** CATE에 대해서조차 CF와 X-learner는 커버리지가 불충분함을 보여줍니다. [cite_start]반면 CQR은 CATE와 ITE 모두에 대해 유효한 커버리지를 달성합니다 [cite: 433-438].

## 4.2 Coverage of CATE

아래 그림은 CATE(조건부 평균)에 대한 커버리지 결과입니다.

![Figure 2: Figure 1 - Empirical 95% coverage of CATE. 8가지 시나리오에 대한 CATE 커버리지 결과입니다. 빨간 실선은 목표 수준인 0.95를 나타냅니다.](./images/figure1_cate_coverage.png)

* [cite_start]**CF & X-learner:** 모든 시나리오에서 저조한 성능을 보이며, 특히 고차원($d=100$)에서 성능이 급격히 하락합니다[cite: 468].
* [cite_start]**BART:** 대체로 좋은 성능을 보이지만, "Correlated Covariates + Heteroscedastic Errors" (가장 오른쪽 열) 시나리오에서는 커버리지가 무너지는 모습을 보입니다[cite: 470].
* **CQR (제안 방법):** ITE를 타겟으로 설계되었음에도 불구하고, 모든 시나리오에서 95% 이상의 CATE 커버리지를 달성합니다. [cite_start]다소 보수적(Conservative)일 수 있으나, 안정적입니다 [cite: 471-473].

## 4.3 Coverage of ITE (Main Result)

이 논문의 핵심 주제인 **개별 처치 효과(ITE)**에 대한 커버리지입니다.

![Figure 3: Figure 2 - Empirical 95% coverage of ITE. ITE에 대한 커버리지 결과입니다. Causal Forest와 X-learner는 ITE 예측 구간을 생성하도록 설계되지 않았으므로 매우 낮은 커버리지를 보입니다.](./images/figure2_ite_coverage.png)

* **CF & X-learner:** 예상대로 ITE를 전혀 커버하지 못합니다. [cite_start]이는 CATE 신뢰 구간을 ITE 예측 구간으로 오해해서는 안 된다는 점을 시사합니다 [cite: 503-504].
* [cite_start]**BART:** 등분산(Homoscedastic) 환경에서는 완벽한 커버리지를 보이지만, 이분산(Heteroscedastic) 환경, 특히 상관관계가 있는 경우 성능이 떨어집니다 [cite: 505-506].
* [cite_start]**CQR:** **모든 시나리오(차원, 상관관계, 이분산성 여부)에서 거의 정확한 95% 커버리지를 달성**합니다[cite: 507].

---

# 5. Results: Interval Length & Efficiency

커버리지가 높다고 무조건 좋은 것은 아닙니다. 구간의 길이가 너무 넓으면 정보가치가 없기 때문입니다.

![Figure 4: Figure 3 - Lengths of interval estimates for ITE. 파란색 수직선은 Oracle Interval(이상적인 길이)을 나타냅니다.](./images/figure3_interval_length.png)

* **CF & X-learner:** 구간 길이가 매우 짧습니다. [cite_start]앞서 보았듯 이는 커버리지 실패(Poor calibration)의 결과이므로 의미가 없습니다[cite: 508].
* **BART vs. CQR:**
    * 등분산(Homoscedastic) 환경에서 BART는 가장 짧은 구간을 생성합니다. [cite_start]CQR(with BART learner)도 이에 근접한 효율성을 보입니다 [cite: 509-510].
    * 이분산(Heteroscedastic) 환경에서 BART의 구간은 너무 짧아 커버리지 실패로 이어집니다. 반면 CQR은 커버리지를 유지하기 위해 구간 길이를 늘립니다. [cite_start]이때 CQR의 구간 길이 변동성이 커지는 경향이 있습니다[cite: 513].

---

# 6. Results: Conditional Coverage

마지막으로, **조건부 커버리지(Conditional Coverage)**를 분석합니다. 이분산 설정($\sigma^2(x) = -\log X_1$)에서는 $X_1 \to 0$일 때 분산이 무한대로 발산하므로, 예측하기 가장 어려운 영역입니다.

![Figure 5: Figure 4 - Estimated conditional coverage of ITE. x축은 조건부 분산의 분위수(Percentile)를 나타냅니다. 오른쪽으로 갈수록 예측이 어려운 데이터 포인트입니다.](./images/figure4_conditional_coverage.png)

* **BART:** 조건부 분산이 커질수록(x축의 오른쪽), 커버리지 확률이 급격히 떨어지는 것을 확인할 수 있습니다. [cite_start]평균적으로는 괜찮을지 몰라도, **불확실성이 큰 환자군에 대해서는 리스크를 과소평가**할 위험이 있습니다 [cite: 587-588].
* **CQR:** 분산이 큰 영역에서도 커버리지를 안정적으로 유지(Flat curve)합니다. [cite_start]특히 Quantile RF나 Quantile Boosting을 사용한 CQR이 BART 기반 CQR보다 더 나은 조건부 커버리지를 보입니다[cite: 589].

---

# 7. Summary

이번 실험 결과는 Weighted Split-CQR의 강력함을 실증적으로 보여주었습니다.

1.  **Robustness:** 기존 방법론(BART 포함)이 실패하는 고차원, 상관관계, 이분산성 환경에서도 CQR은 약속된 커버리지(95%)를 지켜냈습니다.
2.  **Safety:** CATE를 위한 신뢰 구간(CF, X-learner)을 ITE 예측에 무리하게 사용할 경우, 불확실성을 심각하게 과소평가할 수 있음이 드러났습니다.
3.  **Adaptability:** CQR은 데이터의 불확실성 수준(조건부 분산)에 따라 구간의 길이를 적절히 조절하여, 어려운 케이스에서도 신뢰할 수 있는 예측을 제공합니다.

이로써 우리는 평균적인 효과를 넘어, 개별 환자에게 적용 가능한 안전하고 신뢰할 수 있는 인과추론 도구를 확보하게 되었습니다.

---

### 누락 방지 검증 (Compliance Checklist)

1.  **내용 처리:**
    * 시뮬레이션 데이터 생성 과정($X$, $Y(1)$, $e(x)$ 식) 포함? ✅
    * 비교 방법론(CF, X-learner, BART) 및 선정 이유 설명? ✅
    * Table 2 (이론 vs 실제 커버리지 비교) 내용 포함? ✅
    * Figure 1 (CATE Coverage) 분석 포함? ✅
    * Figure 2 (ITE Coverage) 핵심 결과 포함? ✅
    * Figure 3 (Interval Length) 효율성 분석 포함? ✅
    * Figure 4 (Conditional Coverage) 이분산성 환경 분석 포함? ✅

2.  **수식 처리:**
    * 데이터 생성 $f(x)$, $e(x)$, $\sigma^2(x)$ 등의 수식 LaTeX 재현? ✅

3.  **형식:**
    * Quarto YAML Header 작성? ✅
    * 이미지 문법 `![Alt](./path)` 사용 및 캡션 작성? ✅
    * 엄격한 Citation 형식 `` 준수? ✅

4.  **범위:**
    * 섹션 3.6의 내용에 집중하고 4번 섹션 이후 내용은 제외함. ✅